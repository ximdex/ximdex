// Generated by CoffeeScript 1.8.0
angular.module("ximdex.main.controller").controller("XModifyStatesCtrl", [
  "$scope", "$http", "xUrlHelper", "$timeout", "$window", function($scope, $http, xUrlHelper, $timeout, $window) {
    var url;
    url = xUrlHelper.getAction({
      action: 'modifystates',
      method: 'update_states'
    });
    $scope.toDelete = [];
    $scope.thereAreMessages = false;
    $scope.sortableOptions = {
      axis: 'y',
      items: 'li.sortable',
      handle: '.sortable_element'
    };
    $scope.addStatus = function(index) {
      var n;
      n = {
        id: null,
        name: "",
        description: ""
      };
      $scope.all_status_info.splice(index + 1, 0, n);
    };
    $scope.deleteStatus = function(index) {
      $scope.toDelete.push($scope.all_status_info.splice(index, 1)[0]);
    };
    $scope.saveChanges = function() {
      var petition;
      $scope.loading = true;
      petition = $http.post(url, {
        states: $scope.all_status_info,
        idNode: $scope.idNode,
        toDelete: $scope.toDelete
      });
      petition.success(function(data, status, headers, config) {
        $scope.loading = false;
        if (data.result === "ok") {
          $scope.all_status_info = JSON.parse(data.all_status_info);
          $scope.toDelete = [];
          $window.com.ximdex.emptyActionsCache();
        }
        if (data.message !== "") {
          $scope.messageClass = data.result === "ok" ? "message-success" : "message-error";
          $scope.thereAreMessages = true;
          $scope.message = data.message;
          $timeout(function() {
            $scope.thereAreMessages = false;
            $timeout(function() {
              $scope.message = "";
            }, 500);
          }, 2000);
        }
      });
      petition.error(function(data, status, headers, config) {
        $scope.loading = false;
      });
    };
  }
]);
