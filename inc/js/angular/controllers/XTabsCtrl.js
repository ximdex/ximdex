// Generated by CoffeeScript 1.8.0
angular.module("ximdex.main.controller").controller("XTabsCtrl", [
  "$scope", "xTabs", "xUrlHelper", "$http", "$interval", "$window", "$timeout", function($scope, xTabs, xUrlHelper, $http, $interval, $window, $timeout) {
    var rightPosition;
    $scope.tabs = xTabs.getTabs();
    $scope.removeTab = xTabs.removeTab;
    $scope.setActiveTab = xTabs.setActive;
    $scope.closeAllTabs = xTabs.closeAll;
    $scope.offAllTabs = xTabs.offAll;
    $scope.activeIndex = xTabs.activeIndex;
    $scope.submitForm = xTabs.submitForm;
    $scope.closeTabById = xTabs.removeTabById;
    $scope.reloadTabById = xTabs.reloadTabById;
    $scope.openAction = function(action, nodes) {
      var n, newNode, nodesArray, _i, _len;
      nodesArray = [];
      if (Array.isArray(nodes)) {
        for (_i = 0, _len = nodes.length; _i < _len; _i++) {
          n = nodes[_i];
          newNode = {
            nodeid: n
          };
          nodesArray.push(newNode);
        }
      } else if (nodes) {
        nodesArray.push({
          nodeid: nodes
        });
      }
      xTabs.pushTab(action, nodesArray);
    };
    $scope.menuTabsEnabled = false;
    $scope.showingMenu = false;
    $scope.limitTabs = 9999999;
    $scope.reloadWelcomeTab = function() {
      var nodes, url;
      nodes = [
        {
          nodeid: 10000
        }
      ];
      url = xUrlHelper.getAction({
        action: "welcome",
        nodes: nodes
      });
      $http.get(url).success(function(data) {
        var newtab;
        if (data) {
          newtab = {
            id: "10000_welcome",
            name: "welcome",
            content: data,
            nodes: nodes,
            action: null,
            command: "welcome",
            blink: false,
            show: true,
            url: url
          };
          xTabs.loadCssAndJs(newtab);
        }
      });
    };
    $scope.reloadWelcomeTab();
    $scope.closeMenu = function() {
      $scope.showingMenu = false;
    };
    rightPosition = function(elem) {
      return angular.element($window).width() - (angular.element(elem).offset().left + angular.element(elem).outerWidth());
    };
    return $scope.$on('updateTabsPosition', function(event, deletedTab) {
      var a, c, container, containerPosition, containerWidth, contents, contentsWidth, element, elementPosition, i, idContent, newleft, rtContainer, rtElement, temp, widthDeletedTab, _i, _j, _len, _len1, _ref, _ref1;
      temp = angular.element('#angular-content > .hbox-panel > .tabs-container');
      containerPosition = temp.offset();
      containerWidth = temp.width();
      container = angular.element('#angular-content > .hbox-panel > .tabs-container > ul');
      contents = angular.element('#angular-content > .hbox-panel > .tabs-container > ul.ui-tabs-nav > li');
      contentsWidth = 0;
      rtContainer = rightPosition(temp);
      if ($scope.activeIndex() < 0) {
        container.css("left", "0px");
        return;
      }
      idContent = "#" + $scope.tabs[$scope.activeIndex()].id + "_tab";
      if (deletedTab) {
        widthDeletedTab = angular.element("#" + deletedTab.id + "_tab").outerWidth();
      }
      element = angular.element(idContent);
      elementPosition = element.offset().left;
      rtElement = rightPosition(element);
      contents.each(function(index, element) {
        if (index === 0) {
          return;
        }
        return contentsWidth += angular.element(element).width() + 2;
      });
      if (containerWidth - 30 < contentsWidth) {
        $scope.menuTabsEnabled = true;
      } else {
        $scope.menuTabsEnabled = false;
      }
      if ($scope.activeIndex() === $scope.tabs.length - 1) {
        $scope.limitTabs = $scope.activeIndex() + 1;
      }
      if (!$scope.menuTabsEnabled) {
        return;
      }
      if (elementPosition < containerPosition.left) {
        _ref = container.find('li');
        for (i = _i = 0, _len = _ref.length; _i < _len; i = ++_i) {
          a = _ref[i];
          if (i === 0) {
            continue;
          }
          rtElement = (rightPosition(angular.element(a))) - (containerPosition.left - elementPosition);
          if (rtContainer + 30 > rtElement) {
            $scope.limitTabs = i - 1;
            break;
          }
        }
        container.css("left", (parseInt(container.css("left")) + (containerPosition.left - elementPosition)) + "px");
      } else if (rtContainer + 30 > rtElement) {
        $scope.limitTabs = $scope.activeIndex() + 1;
        widthDeletedTab = 0;
        newleft = parseInt(container.css("left")) + rtElement + widthDeletedTab - rtContainer - 40;
        if (deletedTab) {
          _ref1 = container.find("li");
          for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
            c = _ref1[_j];
            if (c.offset().left > newleft) {
              newleft = c.offset().left;
              break;
            }
          }
        }
        container.css("left", newleft + "px");
      }
    });
  }
]);
